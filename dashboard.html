<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Samvaad • Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <style>
      :root{
        --bg:#f7f9fc; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
        --brand:#2563eb; --accent:#10b981; --card:#fff; --chip:#eef2ff;
      }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

      /* Animations */
      @keyframes pop { from{transform:translateY(8px);opacity:.0} to{transform:none;opacity:1} }
      @keyframes fadeIn { from{opacity:0} to{opacity:1} }

      /* Top bar */
      .top{position:sticky;top:0;z-index:20;background:#ffffffcc;backdrop-filter:saturate(180%) blur(10px);
        border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px}
      .brand{display:flex;align-items:center;gap:10px}
      .mark{width:36px;height:36px;border-radius:10px;object-fit:cover;box-shadow:0 6px 14px rgba(37,99,235,.18)}
      .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f1f5f9;font-size:12px}
      .btn{padding:10px 12px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer;transition:transform .08s}
      .btn:active{transform:translateY(1px)}
      .btn.ghost{background:#e8f3f1;color:#0f172a}

      /* Shell */
      .wrap{max-width:1100px;margin:14px auto;padding:0 12px}
      .grid{display:grid;grid-template-columns:340px 1fr;gap:14px}
      @media(max-width:940px){.grid{grid-template-columns:1fr}}

      .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;
        box-shadow:0 12px 30px rgba(2,6,23,.06);animation:pop .35s ease}
      .list{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;animation:fadeIn .25s ease}
      .item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #f1f5f9;transition:background .12s}
      .item:hover{background:#fafcff}
      .item:last-child{border-bottom:none}
      .avatar{width:42px;height:42px;border-radius:50%;background:#eef2ff;display:grid;place-items:center;font-weight:800;color:#334155}
      .name{font-weight:700}
      .sub{font-size:12px;color:var(--muted)}
      .row{display:flex;align-items:center;gap:8px}
      .input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fbfdff}
      .msgbox{height:420px;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;overflow:auto}
      .bubble{max-width:72%;padding:10px 12px;border-radius:14px;margin:6px 0;line-height:1.35}
      .me{background:#e8f3ff;margin-left:auto}
      .them{background:#f1f5f9}
      .empty{display:grid;place-items:center;padding:30px;border:1px dashed var(--line);border-radius:14px;background:#fff}
      .empty .hint{font-size:13px;color:var(--muted)}

      /* Panels + Tabs */
      .panel{display:none}
      .panel.active{display:block}
      .tabs{position:sticky;bottom:0;z-index:15;background:#fff;border-top:1px solid var(--line);display:flex}
      .tab{flex:1;padding:10px 6px;text-align:center;cursor:pointer;font-weight:700;color:#334155}
      .tab.active{color:#0f172a;border-top:3px solid var(--brand);background:#fff}

      /* Section headers */
      .section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
      .title{font-weight:800}
      .chip{padding:6px 10px;border-radius:999px;background:var(--chip);font-size:12px}
    </style>
  </head>
  <body>
    <!-- Top bar -->
    <div class="top">
      <div class="brand">
        <img src="./images/logo-mark.png" class="mark" alt="Samvaad">
        <strong>Samvaad</strong>
      </div>
      <div class="row">
        <span id="user-pill" class="pill">Loading…</span>
        <button id="logout" class="btn">Logout</button>
      </div>
    </div>

    <div class="wrap">
      <!-- Chats panel -->
      <div id="panel-chats" class="panel active">
        <div class="grid">
          <!-- Left: chats list -->
          <div>
            <div class="section-head">
              <div class="row">
                <span class="title">Chats</span>
                <span id="chat-count" class="chip">0</span>
              </div>
              <button id="new-chat" class="btn ghost">New chat</button>
            </div>
            <div id="chat-list" class="list"></div>
            <div id="chats-empty" class="empty" style="display:none;margin-top:10px;">
              <div class="hint">No chats yet. Start a conversation from Users tab or wait for someone to message you.</div>
            </div>
          </div>

          <!-- Right: conversation -->
          <div class="card">
            <div class="section-head">
              <div class="row">
                <div id="conv-avatar" class="avatar">S</div>
                <div>
                  <div id="conv-name" class="name">Select a chat</div>
                  <div id="conv-sub" class="sub">No conversation yet</div>
                </div>
              </div>
              <div class="row"><button id="clear-chat" class="btn ghost">Clear</button></div>
            </div>
            <div id="msgbox" class="msgbox"><div class="sub">Choose a chat from left.</div></div>
            <div class="row" style="margin-top:10px;">
              <input id="msg" class="input" placeholder="Write a message…" />
              <button id="send" class="btn">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Status -->
      <div id="panel-status" class="panel">
        <div class="card">
          <div class="section-head"><span class="title">Status</span></div>
          <div class="row" style="margin-top:6px;">
            <input id="status-text" class="input" placeholder="What’s on your mind?" />
            <button id="post-status" class="btn">Post</button>
          </div>
          <div class="sub" style="margin-top:8px;">Media status next step.</div>
        </div>
      </div>

      <!-- Users -->
      <div id="panel-users" class="panel">
        <div class="section-head">
          <div class="row">
            <span class="title">Users</span>
            <span id="user-count" class="chip">0</span>
          </div>
          <div class="row">
            <button id="pick-contacts" class="btn ghost">Pick contacts</button>
          </div>
        </div>
        <div id="users-list" class="list"></div>
        <div id="users-empty" class="empty" style="display:none;margin-top:10px;">
          <div class="hint">No users found yet.</div>
        </div>
      </div>
    </div>

    <!-- Bottom tabs -->
    <div class="tabs">
      <div id="tab-chats" class="tab active">Chats</div>
      <div id="tab-status" class="tab">Status</div>
      <div id="tab-users" class="tab">Users</div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
      import {
        getFirestore, doc, setDoc, getDoc,
        collection, addDoc, serverTimestamp,
        query, where, getDocs, orderBy, onSnapshot, limit
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBIHeGBPieB4Q8hzYv-tmtRvxwHlY-8HiE",
        authDomain: "samvaad-7970b.firebaseapp.com",
        projectId: "samvaad-7970b",
        storageBucket: "samvaad-7970b.firebasestorage.app",
        messagingSenderId: "246840076262",
        appId: "1:246840076262:web:9458559ec7afa340541827"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Tabs
      const mapTabs = [
        {t:'tab-chats', p:'panel-chats'},
        {t:'tab-status', p:'panel-status'},
        {t:'tab-users',  p:'panel-users' }
      ];
      mapTabs.forEach(({t,p})=>{
        document.getElementById(t).onclick = ()=>{
          mapTabs.forEach(({t,p})=>{
            document.getElementById(t).classList.remove('active');
            document.getElementById(p).classList.remove('active');
          });
          document.getElementById(t).classList.add('active');
          document.getElementById(p).classList.add('active');
        };
      });

      const pill  = document.getElementById('user-pill');
      const logoutBtn = document.getElementById('logout');
      logoutBtn.onclick = async ()=>{ await signOut(auth); location.href = "./"; };

      const chatListEl = document.getElementById('chat-list');
      const chatCountEl = document.getElementById('chat-count');
      const chatsEmpty  = document.getElementById('chats-empty');

      const usersList = document.getElementById('users-list');
      const userCountEl = document.getElementById('user-count');
      const usersEmpty  = document.getElementById('users-empty');

      const msgbox   = document.getElementById('msgbox');
      const msgInput = document.getElementById('msg');
      const sendBtn  = document.getElementById('send');
      const clearBtn = document.getElementById('clear-chat');

      let me=null, currentPeer=null, unsubMessages=null;

      onAuthStateChanged(auth, async (user)=>{
        if(!user) return location.href="./";
        me = user;
        const name = user.displayName || user.phoneNumber || user.email || "User";
        pill.textContent = (name.length>18? name.slice(0,18)+'…':name);

        await upsertUser(user);
        await loadMyChats();            // अगर कोई message history नहीं है → list empty + empty state दिखेगा
        await loadUsers();              // Samvaad users
      });

      async function upsertUser(user){
        await setDoc(doc(db,"users",user.uid),{
          uid:user.uid,
          displayName:user.displayName || null,
          email:user.email || null,
          phone:user.phoneNumber || null,
          photoURL:user.photoURL || null,
          updatedAt: Date.now()
        },{merge:true});
      }

      // Helpers
      function initials(n){ if(!n) return 'U'; const p=(n+'').split(/\s+/).slice(0,2); return p.map(s=>s[0]?.toUpperCase()).join('') || 'U'; }
      function setEmpty(el, show){ el.style.display = show? 'grid':'none'; }

      // CHATS: only threads that have at least one message
      async function loadMyChats(){
        chatListEl.innerHTML = '';
        chatCountEl.textContent = '0';
        setEmpty(chatsEmpty, false);

        // Grab last 50 messages where I am sender or receiver, build peer set
        const qFrom = query(collection(db,"messages"), where("from","==", me.uid), orderBy("ts","desc"), limit(50));
        const qTo   = query(collection(db,"messages"), where("to","==", me.uid),   orderBy("ts","desc"), limit(50));
        const seen = new Map();
        const snaps = await Promise.all([getDocs(qFrom).catch(()=>({})), getDocs(qTo).catch(()=>({}))]);
        snaps.forEach(s=>{
          s?.forEach(d=>{
            const m=d.data(); const peer = (m.from===me.uid? m.to : m.from);
            if(!seen.has(peer)) seen.set(peer, m.ts?.toMillis?.() || 0);
          });
        });

        if(seen.size===0){
          setEmpty(chatsEmpty, true);
          return;
        }

        const peers = [...seen.entries()].sort((a,b)=>b[1]-a[1]).map(x=>x);
        chatCountEl.textContent = String(peers.length);

        for(const uid of peers){
          const u = await getDoc(doc(db,"users",uid));
          const user = u.exists()? u.data(): {displayName:'User', uid};
          chatListEl.appendChild(chatItem(user));
        }
      }

      function chatItem(user){
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div class="avatar">${initials(user.displayName || user.phone || user.email)}</div>
          <div style="min-width:0;flex:1;">
            <div class="name">${user.displayName || user.phone || user.email || 'User'}</div>
            <div class="sub">${user.phone || user.email || ''}</div>
          </div>
          <div class="row">
            <button class="btn ghost" data-open="${user.uid}">Open</button>
          </div>
        `;
        div.querySelector('[data-open]').onclick = ()=> openConversation(user);
        return div;
      }

      async function openConversation(peerUser){
        currentPeer = peerUser;
        document.getElementById('conv-name').textContent = peerUser.displayName || peerUser.phone || peerUser.email || 'User';
        document.getElementById('conv-sub').textContent  = 'Chatting securely';
        document.getElementById('conv-avatar').textContent = initials(peerUser.displayName || peerUser.phone || peerUser.email);
        msgbox.innerHTML='<div class="sub">Loading…</div>';

        if(unsubMessages) unsubMessages();

        // Phase‑1: stream all ordered, filter pair (simple; works for MVP)
        const qAll = query(collection(db,"messages"), orderBy("ts","asc"));
        unsubMessages = onSnapshot(qAll, (snap)=>{
          msgbox.innerHTML='';
          snap.forEach(d=>{
            const m=d.data();
            if((m.from===me.uid && m.to===peerUser.uid) || (m.from===peerUser.uid && m.to===me.uid)){
              const b=document.createElement('div');
              b.className = 'bubble ' + (m.from===me.uid? 'me':'them');
              b.textContent = m.text;
              msgbox.appendChild(b);
            }
          });
          msgbox.scrollTop = msgbox.scrollHeight;
        });
      }

      sendBtn.onclick = async ()=>{
        if(!currentPeer) return alert('Select a chat first');
        const text = msgInput.value.trim();
        if(!text) return;
        await addDoc(collection(db,"messages"),{ from:me.uid, to:currentPeer.uid, text, ts:serverTimestamp() });
        msgInput.value='';
      };
      clearBtn.onclick = ()=>{ msgbox.innerHTML=''; };

      // USERS
      async function loadUsers(){
        usersList.innerHTML=''; setEmpty(usersEmpty, false); userCountEl.textContent='0';
        const snap = await getDocs(query(collection(db,"users")));
        const all=[]; snap.forEach(d=>{ const u=d.data(); if(u.uid!==me.uid) all.push(u); });
        if(all.length===0){ setEmpty(usersEmpty,true); return; }
        userCountEl.textContent = String(all.length);
        all.forEach(u=> usersList.appendChild(userRow(u,true)));
      }

      function userRow(u,isUser){
        const row=document.createElement('div');
        row.className='item';
        const title = u.displayName || u.phone || u.email || 'User';
        row.innerHTML=`
          <div class="avatar">${initials(title)}</div>
          <div style="min-width:0;flex:1;">
            <div class="name">${title}</div>
            <div class="sub">${u.phone || u.email || ''}</div>
          </div>
          <div class="row">
            ${isUser? `<button class="btn ghost" data-chat="${u.uid}">Message</button>`
                     : `<button class="btn" data-invite="${u.contact||''}">Invite</button>`}
          </div>`;
        if(isUser){
          row.querySelector('[data-chat]').onclick = async ()=>{
            let peer=u;
            if(!peer.uid){ const dd=await getDoc(doc(db,"users",u.uid)); if(dd.exists()) peer=dd.data(); }
            openConversation(peer);
          };
        }else{
          row.querySelector('[data-invite]').onclick = ()=>{
            const shareText = `Join me on Samvaad! ${location.origin}${location.pathname.replace(/dashboard\.html$/,'')}`;
            if(navigator.share){ navigator.share({title:"Samvaad invite",text:shareText}).catch(()=>{}); }
            else alert('Copy & share:\n'+shareText);
          };
        }
        return row;
      }

      // Contacts → match users / invite others
      document.getElementById('pick-contacts').onclick = async ()=>{
        if (!('contacts' in navigator) || !('select' in navigator.contacts)) {
          alert('Contacts Picker not supported here.');
          return;
        }
        const list = await navigator.contacts.select(['name','tel','email'], {multiple:true});
        if(!list || list.length===0) return;

        const phones=[]; const emails=[];
        const rows = list.map(c=>{
          const name = Array.isArray(c.name)? c.name[0] : c.name;
          const tel  = Array.isArray(c.tel)?  c.tel  : c.tel;
          const email= Array.isArray(c.email)?c.email: c.email;
          const phone = normPhone(tel||'');
          if(phone) phones.push(phone);
          if(email) emails.push(String(email).toLowerCase());
          return { name:name || phone || email || 'Unknown', phone, email: email? String(email).toLowerCase():null };
        });

        const foundByPhone = phones.length? await findUsersBy('phone', phones) : new Map();
        const foundByEmail = emails.length? await findUsersBy('email', emails) : new Map();

        usersList.innerHTML=''; let had=false;
        rows.forEach(r=>{
          let m=null;
          if(r.phone && foundByPhone.has(r.phone)) m=foundByPhone.get(r.phone);
          else if(r.email && foundByEmail.has(r.email)) m=foundByEmail.get(r.email);
          if(m){ usersList.appendChild(userRow(m,true)); had=true; }
        });
        rows.forEach(r=>{
          let m=null;
          if(r.phone && foundByPhone.has(r.phone)) m=foundByPhone.get(r.phone);
          else if(r.email && foundByEmail.has(r.email)) m=foundByEmail.get(r.email);
          if(!m){ usersList.appendChild(userRow({displayName:r.name, phone:r.phone, email:r.email, contact:r.phone||r.email},false)); had=true; }
        });
        if(!had) setEmpty(usersEmpty,true);
      };

      function normPhone(s){
        if(!s) return null; let x=s.replace(/[^\d+]/g,''); if(x.startsWith('00')) x='+'+x.slice(2);
        if(!x.startsWith('+')) return null; if(x.length<10 || x.length>16) return null; return x;
      }
      async function findUsersBy(field, values){
        const chunks=[]; for(let i=0;i<values.length;i+=10) chunks.push(values.slice(i,i+10));
        const map=new Map();
        for(const batch of chunks){
          const qRef = query(collection(db,'users'), where(field,'in', batch));
          const snap = await getDocs(qRef);
          snap.forEach(d=>{ const u=d.data(); if(u[field]) map.set(u[field], u); });
        }
        return map;
      }
    </script>
  </body>
</html>
