<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Samvaad • Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              bg: '#f8fbfb',
              ink: '#0e1b18',
              line: '#e7efee',
              brand: { 600: '#2563eb' },
              mint: { 50: '#e8f3f1', 500: '#50958a' },
              chat: { base:'#12211f', panel:'#254640', mint:'#20dfbf', sub:'#95c6be', line:'#2b4b45' }
            },
            boxShadow: { card:'0 12px 30px rgba(2,6,23,.06)', soft:'0 8px 20px rgba(2,6,23,.05)' },
            borderRadius: { xl2:'1rem' }
          },
          fontFamily: { sans:['Inter','Noto Sans','system-ui','sans-serif'] }
        }
      }
    </script>
    <style>
      .tap{transition:transform .06s ease}.tap:active{transform:translateY(1px)}
      .card-reveal{animation:reveal .25s ease both}
      @keyframes reveal{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    </style>
  </head>
  <body class="bg-bg text-ink font-sans min-h-screen overflow-x-hidden">
    <!-- Top App Bar -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-line">
      <div class="max-w-[1200px] mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <img src="./images/logo-mark.png" alt="Samvaad" class="w-9 h-9 rounded-xl shadow-soft object-cover" />
          <strong class="text-lg">Samvaad</strong>
          <span id="uid-pill" class="hidden sm:inline ml-2 text-xs bg-gray-100 rounded-full px-3 py-1">Loading…</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="hidden md:flex items-center gap-2 bg-white border border-line rounded-xl px-3 py-2">
            <svg width="18" height="18" viewBox="0 0 24 24" class="text-gray-500"><path fill="currentColor" d="m20.94 20.94l-4.36-4.36A8.5 8.5 0 1 0 18.5 17l4.36 4.36zM10.5 17a6.5 6.5 0 1 1 6.5-6.5A6.51 6.51 0 0 1 10.5 17"/></svg>
            <input id="search" class="border-none focus:ring-0 text-sm w-56" placeholder="Search" />
          </div>
          <button id="logout" class="tap bg-brand-600 text-white font-bold px-3 py-2 rounded-xl">Logout</button>
        </div>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="max-w-[1200px] mx-auto px-4 py-4 grid grid-cols-1 md:grid-cols-[320px_1fr] gap-4">
      <!-- Left Rail -->
      <aside class="bg-bg rounded-xl2 p-4 min-h-[620px] flex flex-col justify-between">
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-cover bg-center" style="background-image:url('https://i.pravatar.cc/100?img=12')"></div>
            <h1 id="user-name" class="text-base font-medium">Guest</h1>
          </div>

          <nav class="flex flex-col gap-1">
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="chats">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M216,80H184V48a16,16,0,0,0-16-16H40A16,16,0,0,0,24,48V176a8,8,0,0,0,13,6.22L72,154V184a16,16,0,0,0,16,16h93.59L219,230.22a8,8,0,0,0,5,1.78,8,8,0,0,0,8-8V96A16,16,0,0,0,216,80Z"/></svg>
              </span>
              <span class="text-sm font-medium">Chats</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="communities">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M244.8,150.4a8,8,0,0,1-11.2-1.6A51.6,51.6,0,0,0,192,128a8,8,0,0,1-7.37-4.89,8,8,0,0,1,0-6.22A8,8,0,0,1,192,112a24,24,0,1,0-23.24-30,8,8,0,1,1-15.5-4A40,40,0,1,1,219,117.51a67.94,67.94,0,0,1,27.43,21.68A8,8,0,0,1,244.8,150.4Z"/></svg>
              </span>
              <span class="text-sm font-medium">Communities</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="updates">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92Z"/></svg>
              </span>
              <span class="text-sm font-medium">Updates</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="calls">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L134.87,160c-15.42-7.49-31.34-23.29-38.83-38.51l20.78-24.71c.2-.25.39-.5.57-.77a16,16,0,0,0,1.32-15.06l0-.12L97.54,33.64a16,16,0,0,0-16.62-9.52A56.26,56.26,0,0,0,32,80c0,79.4,64.6,144,144,144a56.26,56.26,0,0,0,55.88-48.92A16,16,0,0,0,222.37,158.46Z"/></svg>
              </span>
              <span class="text-sm font-medium">Calls</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl bg-mint-50 border border-line" data-nav="settings">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M216,130.16q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.6,107.6,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.29,107.29,0,0,0-26.25-10.86,8,8,0,0,0-7.06,1.48L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,73.89,34.51a8,8,0,0,0-3.93,6L67.32,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.25,8,8,0,0,0,1.49,7.06L40,125.84Q40,128,40,130.16L25.11,148.8a8,8,0,0,0-1.48,7.06,107.6,107.6,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.25,10.87,8,8,0,0,0,7.06-1.49L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.25,8,8,0,0,0-1.49-7.06ZM128,168a40,40,0,1,1,40-40A40,40,0,0,1,128,168Z"/></svg>
              </span>
              <span class="text-sm font-medium">Settings</span>
            </button>
          </nav>
        </div>
        <div class="hidden md:block text-xs text-gray-500 px-1">App version 0.2.0</div>
      </aside>

      <!-- Content -->
      <main class="flex-1">
        <div class="flex flex-wrap justify-between gap-3 p-4">
          <p id="view-title" class="tracking-tight text-[28px] md:text-[32px] font-bold">Settings</p>
        </div>

        <!-- VIEW: Chats (Dark) -->
        <section id="view-chats" class="hidden bg-chat-base text-white min-h-[calc(100vh-64px)]">
          <div class="px-4 md:px-40 py-4">
            <div class="flex items-center justify-between">
              <div>
                <p id="peer-name" class="text-[28px] font-bold">Chat</p>
                <p id="peer-status" class="text-chat-sub text-sm">Select a user to start</p>
              </div>
              <div class="flex gap-2">
                <button class="h-10 px-3 rounded-xl bg-chat-panel">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"/></svg>
                </button>
                <button class="h-10 px-3 rounded-xl bg-chat-panel">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Zm0,16V152h-28.7A15.86,15.86,0,0,0,168,156.69L148.69,176H107.31L88,156.69A15.86,15.86,0,0,0,76.69,152H48V48Zm0,160H48V168H76.69L96,187.31A15.86,15.86,0,0,0,107.31,192h41.38A15.86,15.86,0,0,0,160,187.31L179.31,168H208v40Z"/></svg>
                </button>
              </div>
            </div>
          </div>

          <main id="timeline" class="px-4 md:px-40 pb-28 space-y-2">
            <div id="chat-empty" class="text-sm text-chat-sub">Open a chat from Users or tap + to start.</div>
          </main>

          <!-- FAB like WhatsApp -->
          <button id="fab-new-chat"
            class="fixed bottom-24 right-5 md:right-10 h-14 w-14 rounded-full bg-chat-mint text-[#12211f] shadow-[0_10px_24px_rgba(0,0,0,.35)] grid place-items-center tap"
            title="New chat">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor"><path d="M13 11V6a1 1 0 1 0-2 0v5H6a1 1 0 1 0 0 2h5v5a1 1 0 1 0 2 0v-5h5a1 1 0 1 0 0-2h-5z"/></svg>
          </button>

          <!-- Contacts Modal -->
          <div id="contacts-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/50"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl p-4 max-h-[70vh] overflow-auto
                        md:left-1/2 md:top-1/2 md:bottom-auto md:right-auto md:-translate-x-1/2 md:-translate-y-1/2 md:rounded-2xl md:w-[520px]">
              <div class="flex items-center justify-between mb-3">
                <div class="font-bold">Start new chat</div>
                <button id="contacts-close" class="tap px-3 py-1 rounded-lg bg-gray-100">Close</button>
              </div>
              <div class="mb-3">
                <input id="contacts-search" placeholder="Search contacts"
                       class="w-full border border-gray-200 rounded-xl px-3 py-2"/>
              </div>
              <div id="contacts-list" class="divide-y divide-gray-100"></div>
              <div id="contacts-empty" class="text-sm text-gray-500 py-6 hidden">
                No contacts found or permission denied.
              </div>
            </div>
          </div>

          <footer class="fixed bottom-0 inset-x-0 bg-chat-base/95 backdrop-blur border-t border-chat-line">
            <div class="px-4 md:px-40 py-3">
              <div class="flex items-center gap-3 @container">
                <div class="flex w-full items-stretch rounded-xl overflow-hidden">
                  <input id="msg" placeholder="Type a message"
                         class="flex-1 h-12 px-4 bg-chat-panel text-white placeholder:text-chat-sub border-none focus:ring-0"/>
                  <div class="flex items-center gap-3 pr-3 bg-chat-panel">
                    <button class="p-1.5 text-chat-sub" title="Emoji">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM80,108a12,12,0,1,1,12,12A12,12,0,0,1,80,108Zm96,0a12,12,0,1,1-12-12A12,12,0,0,1,176,108Zm-1.07,48c-10.29,17.79-27.4,28-46.93,28s-36.63-10.2-46.92-28a8,8,0,1,1,13.84-8c7.47,12.91,19.21,20,33.08,20s25.61-7.1,33.07-20a8,8,0,0,1,13.86,8Z"/></svg>
                    </button>
                    <button class="p-1.5 text-chat-sub" title="Attach">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M209.66,122.34a8,8,0,0,1,0,11.32l-82.05,82a56,56,0,0,1-79.2-79.21L147.67,35.73a40,40,0,1,1,56.61,56.55L105,193A24,24,0,1,1,71,159L154.3,74.38A8,8,0,1,1,165.7,85.6L82.39,170.31a8,8,0,1,0,11.27,11.36L192.93,81A24,24,0,1,0,159,47L59.76,147.68a40,40,0,1,0,56.53,56.62l82.06-82A8,8,0,0,1,209.66,122.34Z"/></svg>
                    </button>
                  </div>
                </div>
                <button id="send" class="h-10 px-5 rounded-xl bg-chat-mint text-[#12211f] font-semibold hidden @[480px]:block">Send</button>
              </div>
            </div>
          </footer>
        </section>

        <!-- VIEW: Settings (placeholders only) -->
        <section id="view-settings" class="block">
          <div class="px-4 pt-2 pb-1">
            <h3 class="text-lg font-bold">Settings</h3>
          </div>
          <div class="divide-y divide-line bg-white rounded-xl border border-line mx-4 overflow-hidden">
            <button class="w-full text-left px-4 py-3 hover:bg-mint-50">Profile</button>
            <button class="w-full text-left px-4 py-3 hover:bg-mint-50">Phone</button>
            <button class="w-full text-left px-4 py-3 hover:bg-mint-50">Privacy</button>
          </div>
          <div class="mt-4 divide-y divide-line bg-white rounded-xl border border-line mx-4 overflow-hidden">
            <button class="w-full text-left px-4 py-3 hover:bg-mint-50">Notifications</button>
          </div>
          <div class="mt-4 divide-y divide-line bg-white rounded-xl border border-line mx-4 overflow-hidden">
            <button class="w-full text-left px-4 py-3 hover:bg-mint-50">Help center</button>
            <button class="w-full text-left px-4 py-3 hover:bg-mint-50">Contact us</button>
            <button class="w-full text-left px-4 py-3 hover:bg-mint-50">Terms and privacy policy</button>
          </div>
          <p class="text-xs text-gray-500 px-5 mt-4">All settings are placeholders right now.</p>
        </section>

        <!-- Placeholders -->
        <section id="view-communities" class="hidden">
          <div class="bg-white border border-line rounded-xl shadow-card p-6">Communities coming soon.</div>
        </section>
        <section id="view-updates" class="hidden">
          <div class="bg-white border border-line rounded-xl shadow-card p-6">Updates coming soon.</div>
        </section>
        <section id="view-calls" class="hidden">
          <div class="bg-white border border-line rounded-xl shadow-card p-6">Calls coming soon.</div>
        </section>
      </main>
    </div>

    <!-- Firebase + Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
      import {
        getFirestore, doc, getDoc, collection, addDoc, serverTimestamp,
        query, orderBy, onSnapshot, where, getDocs
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBIHeGBPieB4Q8hzYv-tmtRvxwHlY-8HiE",
        authDomain: "samvaad-7970b.firebaseapp.com",
        projectId: "samvaad-7970b",
        storageBucket: "samvaad-7970b.firebasestorage.app",
        messagingSenderId: "246840076262",
        appId: "1:246840076262:web:9458559ec7afa340541827"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Auth bind
      const nameEl = document.getElementById('user-name');
      const uidPill = document.getElementById('uid-pill');

      onAuthStateChanged(auth, (user)=>{
        if(!user) return location.href = './';
        const n = user.displayName || user.phoneNumber || user.email || 'User';
        if (nameEl) nameEl.textContent = n;
        if (uidPill) uidPill.textContent = `UID: ${user.uid.slice(0,6)}…`;
        me = user;
        setPeerFromURL();
      });

      // Logout
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn){
        logoutBtn.addEventListener('click', async ()=>{
          try{
            logoutBtn.disabled = true;
            logoutBtn.textContent = 'Logging out…';
            await signOut(auth);
          }catch(e){} finally{
            window.location.href = './';
          }
        });
      }

      // View switcher
      function switchView(name){
        const map = {
          chats: document.getElementById('view-chats'),
          settings: document.getElementById('view-settings'),
          communities: document.getElementById('view-communities'),
          updates: document.getElementById('view-updates'),
          calls: document.getElementById('view-calls'),
        };
        Object.values(map).forEach(el => { if (el) el.classList.add('hidden'); });
        if (map[name]) map[name].classList.remove('hidden');
        const vt = document.getElementById('view-title');
        if (vt) vt.textContent = name[0].toUpperCase()+name.slice(1);
        document.querySelectorAll('[data-nav]').forEach(b=>{
          const on = b.getAttribute('data-nav')===name;
          b.classList.toggle('bg-mint-50', on);
          b.classList.toggle('border', on);
          b.classList.toggle('border-line', on);
        });
      }
      ['chats','settings','communities','updates','calls'].forEach(n=>{
        const btn = document.querySelector(`[data-nav="${n}"]`);
        if (btn) btn.addEventListener('click', ()=> switchView(n));
      });

      // Chat glue (MVP)
      let me=null, peer=null, unsub=null;
      const tl = document.getElementById('timeline');
      const input = document.getElementById('msg');
      const sendBtn = document.getElementById('send');
      const peerNameEl = document.getElementById('peer-name');
      const peerStatusEl = document.getElementById('peer-status');
      const emptyEl = document.getElementById('chat-empty');

      function bubble(text, mine=false){
        if (!tl) return;
        const wrap = document.createElement('div');
        wrap.className = 'flex items-end gap-3 p-2 ' + (mine?'justify-end':'');
        wrap.innerHTML = mine
          ? `<div class="flex flex-1 flex-col gap-1 items-end">
               <p class="text-chat-sub text-[13px] max-w-[360px] text-right">You</p>
               <p class="max-w-[360px] rounded-xl px-4 py-3 bg-chat-mint text-[#12211f] shadow-[0_10px_24px_rgba(0,0,0,.25)]">${text}</p>
             </div>
             <div class="w-10 h-10 rounded-full bg-cover bg-center shrink-0" style="background-image:url('https://i.pravatar.cc/100?img=5')"></div>`
          : `<div class="w-10 h-10 rounded-full bg-cover bg-center shrink-0" style="background-image:url('https://i.pravatar.cc/100?img=12')"></div>
             <div class="flex flex-1 flex-col gap-1 items-start">
               <p class="text-chat-sub text-[13px] max-w-[360px]">${(peerNameEl?.textContent || 'User')}</p>
               <p class="max-w-[360px] rounded-xl px-4 py-3 bg-chat-panel text-white shadow-[0_10px_24px_rgba(0,0,0,.25)]">${text}</p>
             </div>`;
        tl.appendChild(wrap);
        tl.scrollTop = tl.scrollHeight;
      }

      async function setPeerFromURL(){
        const q = new URLSearchParams(location.search);
        const pid = q.get('peer');
        if (!pid) return;
        try{
          const snap = await getDoc(doc(db,'users',pid));
          if (snap.exists()){
            peer = snap.data();
            if (peerNameEl) peerNameEl.textContent = peer.displayName || peer.phone || peer.email || 'User';
            if (peerStatusEl) peerStatusEl.textContent = 'Secure chat';
            if (emptyEl) emptyEl.remove();
            switchView('chats');
            listenPair();
          }
        }catch(e){}
      }

      function listenPair(){
        if (!me || !peer) return;
        if (unsub) unsub();
        const qAll = query(collection(db,'messages'), orderBy('ts','asc'));
        unsub = onSnapshot(qAll, s=>{
          if (!tl) return;
          tl.innerHTML = '';
          s.forEach(d=>{
            const m = d.data();
            if ((m.from===me.uid && m.to===peer.uid) || (m.from===peer.uid && m.to===me.uid)){
              bubble(m.text, m.from===me.uid);
            }
          });
          tl.scrollTop = tl.scrollHeight;
        });
      }

      sendBtn?.addEventListener('click', async ()=>{
        if (!peer) { alert('Select a user first (?peer=UID)'); return; }
        const text = (input?.value || '').trim();
        if (!text) return;
        await addDoc(collection(db,'messages'), { from: me.uid, to: peer.uid, text, ts: serverTimestamp() });
        if (input) input.value = '';
      });

      // Open chat helper (used by contacts modal)
      function openChatWith(uid){
        const url = new URL(window.location.href);
        url.searchParams.set('peer', uid);
        window.history.pushState({}, '', url.toString());
        setPeerFromURL();
        switchView('chats');
      }

      // WhatsApp-like FAB + Contacts Picker
      const fabNew = document.getElementById('fab-new-chat');
      const modal = document.getElementById('contacts-modal');
      const closeBtn = document.getElementById('contacts-close');
      const listEl = document.getElementById('contacts-list');
      const emptyState = document.getElementById('contacts-empty');
      const searchInput = document.getElementById('contacts-search');

      function showContacts(open=true){
        if (!modal) return;
        modal.classList.toggle('hidden', !open);
        if (open){ listEl.innerHTML=''; emptyState.classList.add('hidden'); loadContacts(); }
      }
      fabNew?.addEventListener('click', ()=> showContacts(true));
      closeBtn?.addEventListener('click', ()=> showContacts(false));
      modal?.addEventListener('click', (e)=>{ if(e.target===modal) showContacts(false); });

      function contactRow(item){
        const {name, phone, email, matchedUser} = item;
        const title = name || phone || email || 'Unknown';
        const sub = phone || email || '';
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 py-2';
        div.innerHTML = `
          <div class="w-10 h-10 rounded-full bg-gray-100 grid place-items-center font-bold">${(title||'U').slice(0,1).toUpperCase()}</div>
          <div class="min-w-0 flex-1">
            <div class="font-semibold truncate">${title}</div>
            <div class="text-xs text-gray-500 truncate">${sub}</div>
          </div>
          <button class="tap ${matchedUser?'bg-gray-900 text-white':'bg-chat-mint text-[#12211f]'} px-3 py-1 rounded-lg text-sm">
            ${matchedUser ? 'Message' : 'Invite'}
          </button>
        `;
        div.querySelector('button').onclick = ()=>{
          if (matchedUser){
            openChatWith(matchedUser.uid);
            showContacts(false);
          }else{
            const shareText = `Join me on Samvaad! ${location.origin}${location.pathname}`;
            if (navigator.share) navigator.share({title:'Samvaad', text:shareText}).catch(()=>{});
            else alert('Copy & share:\n'+shareText);
          }
        };
        return div;
      }

      function normPhone(s){
        if(!s) return null;
        let x = String(s).replace(/[^\d+]/g,'');
        if (x.startsWith('00')) x = '+'+x.slice(2);
        if (!x.startsWith('+')) return null;
        if (x.length < 10 || x.length > 16) return null;
        return x;
      }

      async function getDeviceContacts(){
        try{
          if (!('contacts' in navigator) || !('select' in navigator.contacts)) return [];
          const picked = await navigator.contacts.select(['name','tel','email'], {multiple:true});
          if (!picked?.length) return [];
          return picked.map(c=>{
            const name = Array.isArray(c.name)? c.name[0] : c.name || '';
            const tel  = Array.isArray(c.tel)?  c.tel  : c.tel || '';
            const email= Array.isArray(c.email)?c.email: c.email || '';
            return { name, phone: normPhone(tel), email: email? String(email).toLowerCase(): null };
          });
        }catch{ return []; }
      }

      async function findMatches(contacts){
        const phones = [...new Set(contacts.map(c=>c.phone).filter(Boolean))];
        const emails = [...new Set(contacts.map(c=>c.email).filter(Boolean))];
        const byPhone = new Map(), byEmail = new Map();

        async function batched(field, values, put){
          for(let i=0;i<values.length;i+=10){
            const batch = values.slice(i,i+10);
            const qRef = query(collection(db,'users'), where(field,'in', batch));
            const snap = await getDocs(qRef);
            snap.forEach(d=>{ const u=d.data(); if (u[field]) put(u[field], u); });
          }
        }
        if (phones.length) await batched('phone', phones, (k,v)=>byPhone.set(k,v));
        if (emails.length) await batched('email', emails, (k,v)=>byEmail.set(k,v));

        return contacts.map(c=>{
          const match = (c.phone && byPhone.get(c.phone)) || (c.email && byEmail.get(c.email)) || null;
          return {...c, matchedUser: match};
        });
      }

      async function loadContacts(){
        const contacts = await getDeviceContacts();
        if (!contacts.length){ emptyState.classList.remove('hidden'); return; }
        const rows = await findMatches(contacts);

        function render(f=''){
          listEl.innerHTML='';
          let shown=0;
          rows.filter(r=>{
            if(!f) return true;
            const s=f.toLowerCase();
            return (r.name||'').toLowerCase().includes(s) || (r.phone||'').includes(s) || (r.email||'').includes(s);
          }).forEach(r=>{ listEl.appendChild(contactRow(r)); shown++; });
          emptyState.classList.toggle('hidden', shown>0);
        }
        render();
        searchInput?.addEventListener('input', e=>render(e.target.value));
      }
    </script>
  </body>
</html>

      