<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Samvaad • Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              bg: '#f8fbfb',
              ink: '#0e1b18',
              line: '#e7efee',
              brand: { 600: '#2563eb' },
              mint: { 50: '#e8f3f1', 500: '#50958a' },
              chat: { base:'#12211f', panel:'#254640', mint:'#20dfbf', sub:'#95c6be', line:'#2b4b45' }
            },
            boxShadow: { card:'0 12px 30px rgba(2,6,23,.06)', soft:'0 8px 20px rgba(2,6,23,.05)' },
            borderRadius: { xl2:'1rem' }
          },
          fontFamily: { sans:['Inter','Noto Sans','system-ui','sans-serif'] }
        }
      }
    </script>
    <style>
      .tap{transition:transform .06s ease}.tap:active{transform:translateY(1px)}
      .card-reveal{animation:reveal .25s ease both}
      @keyframes reveal{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    </style>
  </head>
  <body class="bg-bg text-ink font-sans min-h-screen overflow-x-hidden">
    <!-- Top App Bar -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-line">
      <div class="max-w-[1200px] mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <img src="./images/logo-mark.png" alt="Samvaad" class="w-9 h-9 rounded-xl shadow-soft object-cover" />
          <strong class="text-lg">Samvaad</strong>
          <span id="uid-pill" class="hidden sm:inline ml-2 text-xs bg-gray-100 rounded-full px-3 py-1">Loading…</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="hidden md:flex items-center gap-2 bg-white border border-line rounded-xl px-3 py-2">
            <svg width="18" height="18" viewBox="0 0 24 24" class="text-gray-500"><path fill="currentColor" d="m20.94 20.94l-4.36-4.36A8.5 8.5 0 1 0 18.5 17l4.36 4.36zM10.5 17a6.5 6.5 0 1 1 6.5-6.5A6.51 6.51 0 0 1 10.5 17"/></svg>
            <input id="search" class="border-none focus:ring-0 text-sm w-56" placeholder="Search settings" />
          </div>
          <button id="logout" class="tap bg-brand-600 text-white font-bold px-3 py-2 rounded-xl">Logout</button>
        </div>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="max-w-[1200px] mx-auto px-4 py-4 grid grid-cols-1 md:grid-cols-[320px_1fr] gap-4">
      <!-- Left Rail -->
      <aside class="bg-bg rounded-xl2 p-4 min-h-[620px] flex flex-col justify-between">
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-cover bg-center" style="background-image:url('https://i.pravatar.cc/100?img=12')"></div>
            <h1 id="user-name" class="text-base font-medium">Guest</h1>
          </div>

          <nav class="flex flex-col gap-1">
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="chats">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M216,80H184V48a16,16,0,0,0-16-16H40A16,16,0,0,0,24,48V176a8,8,0,0,0,13,6.22L72,154V184a16,16,0,0,0,16,16h93.59L219,230.22a8,8,0,0,0,5,1.78,8,8,0,0,0,8-8V96A16,16,0,0,0,216,80Z"/></svg>
              </span>
              <span class="text-sm font-medium">Chats</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="communities">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M244.8,150.4a8,8,0,0,1-11.2-1.6A51.6,51.6,0,0,0,192,128a8,8,0,0,1-7.37-4.89,8,8,0,0,1,0-6.22A8,8,0,0,1,192,112a24,24,0,1,0-23.24-30,8,8,0,1,1-15.5-4A40,40,0,1,1,219,117.51a67.94,67.94,0,0,1,27.43,21.68A8,8,0,0,1,244.8,150.4Z"/></svg>
              </span>
              <span class="text-sm font-medium">Communities</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="updates">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92Z"/></svg>
              </span>
              <span class="text-sm font-medium">Updates</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white border border-transparent hover:border-line" data-nav="calls">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L134.87,160c-15.42-7.49-31.34-23.29-38.83-38.51l20.78-24.71c.2-.25.39-.5.57-.77a16,16,0,0,0,1.32-15.06l0-.12L97.54,33.64a16,16,0,0,0-16.62-9.52A56.26,56.26,0,0,0,32,80c0,79.4,64.6,144,144,144a56.26,56.26,0,0,0,55.88-48.92A16,16,0,0,0,222.37,158.46Z"/></svg>
              </span>
              <span class="text-sm font-medium">Calls</span>
            </button>
            <button class="tap flex items-center gap-3 px-3 py-2 rounded-xl bg-mint-50 border border-line" data-nav="settings">
              <span class="text-ink">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M216,130.16q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.6,107.6,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.29,107.29,0,0,0-26.25-10.86,8,8,0,0,0-7.06,1.48L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,73.89,34.51a8,8,0,0,0-3.93,6L67.32,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.25,8,8,0,0,0,1.49,7.06L40,125.84Q40,128,40,130.16L25.11,148.8a8,8,0,0,0-1.48,7.06,107.6,107.6,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.25,10.87,8,8,0,0,0,7.06-1.49L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.25,8,8,0,0,0-1.49-7.06ZM128,168a40,40,0,1,1,40-40A40,40,0,0,1,128,168Z"/></svg>
              </span>
              <span class="text-sm font-medium">Settings</span>
            </button>
          </nav>
        </div>
        <div class="hidden md:block text-xs text-gray-500 px-1">App version 0.2.0</div>
      </aside>

      <!-- Content -->
      <main class="flex-1">
        <div class="flex flex-wrap justify-between gap-3 p-4">
          <p id="view-title" class="tracking-tight text-[28px] md:text-[32px] font-bold">Settings</p>
        </div>

        <!-- VIEW: Chats (Dark) -->
        <section id="view-chats" class="hidden bg-chat-base text-white min-h-[calc(100vh-64px)]">
          <div class="px-4 md:px-40 py-4">
            <div class="flex items-center justify-between">
              <div>
                <p id="peer-name" class="text-[28px] font-bold">Chat</p>
                <p id="peer-status" class="text-chat-sub text-sm">Select a user to start</p>
              </div>
              <div class="flex gap-2">
                <button class="h-10 px-3 rounded-xl bg-chat-panel">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"/></svg>
                </button>
                <button class="h-10 px-3 rounded-xl bg-chat-panel">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Zm0,16V152h-28.7A15.86,15.86,0,0,0,168,156.69L148.69,176H107.31L88,156.69A15.86,15.86,0,0,0,76.69,152H48V48Zm0,160H48V168H76.69L96,187.31A15.86,15.86,0,0,0,107.31,192h41.38A15.86,15.86,0,0,0,160,187.31L179.31,168H208v40Z"/></svg>
                </button>
              </div>
            </div>
          </div>

          <main id="timeline" class="px-4 md:px-40 pb-24 space-y-2">
            <div id="chat-empty" class="text-sm text-chat-sub">Open a chat from Users or pass ?peer=UID in URL.</div>
          </main>

          <footer class="fixed bottom-0 inset-x-0 bg-chat-base/95 backdrop-blur border-t border-chat-line">
            <div class="px-4 md:px-40 py-3">
              <div class="flex items-center gap-3 @container">
                <div class="flex w-full items-stretch rounded-xl overflow-hidden">
                  <input id="msg" placeholder="Type a message"
                         class="flex-1 h-12 px-4 bg-chat-panel text-white placeholder:text-chat-sub border-none focus:ring-0"/>
                  <div class="flex items-center gap-3 pr-3 bg-chat-panel">
                    <button class="p-1.5 text-chat-sub" title="Emoji">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM80,108a12,12,0,1,1,12,12A12,12,0,0,1,80,108Zm96,0a12,12,0,1,1-12-12A12,12,0,0,1,176,108Zm-1.07,48c-10.29,17.79-27.4,28-46.93,28s-36.63-10.2-46.92-28a8,8,0,1,1,13.84-8c7.47,12.91,19.21,20,33.08,20s25.61-7.1,33.07-20a8,8,0,0,1,13.86,8Z"/></svg>
                    </button>
                    <button class="p-1.5 text-chat-sub" title="Attach">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M209.66,122.34a8,8,0,0,1,0,11.32l-82.05,82a56,56,0,0,1-79.2-79.21L147.67,35.73a40,40,0,1,1,56.61,56.55L105,193A24,24,0,1,1,71,159L154.3,74.38A8,8,0,1,1,165.7,85.6L82.39,170.31a8,8,0,1,0,11.27,11.36L192.93,81A24,24,0,1,0,159,47L59.76,147.68a40,40,0,1,0,56.53,56.62l82.06-82A8,8,0,0,1,209.66,122.34Z"/></svg>
                    </button>
                  </div>
                </div>
                <button id="send" class="h-10 px-5 rounded-xl bg-chat-mint text-[#12211f] font-semibold hidden @[480px]:block">Send</button>
              </div>
            </div>
          </footer>
        </section>

        <!-- VIEW: Settings -->
        <section id="view-settings" class="block">
          <section class="space-y-2">
            <h3 class="px-4 pt-2 pb-1 text-lg font-bold">Account</h3>
            <div class="flex items-center gap-4 bg-bg px-4 min-h-[72px] py-2 justify-between rounded-xl border border-line card-reveal">
              <div class="flex items-center gap-4">
                <div class="h-14 w-14 rounded-full bg-cover bg-center" style="background-image:url('https://i.pravatar.cc/100?img=12')"></div>
                <div>
                  <p class="font-medium">Profile</p>
                  <p id="acc-name" class="text-mint-500 text-sm">Loading…</p>
                </div>
              </div>
              <div class="shrink-0 text-ink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/></svg></div>
            </div>

            <div class="flex items-center gap-4 bg-bg px-4 min-h-[72px] py-2 justify-between rounded-xl border border-line card-reveal">
              <div class="flex items-center gap-4">
                <div class="rounded-lg bg-mint-50 w-12 h-12 grid place-items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"><path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L134.87,160c-15.42-7.49-31.34-23.29-38.83-38.51l20.78-24.71c.2-.25.39-.5.57-.77a16,16,0,0,0,1.32-15.06l0-.12L97.54,33.64a16,16,0,0,0-16.62-9.52A56.26,56.26,0,0,0,32,80c0,79.4,64.6,144,144,144a56.26,56.26,0,0,0,55.88-48.92A16,16,0,0,0,222.37,158.46Z"/></svg>
                </div>
                <div>
                  <p class="font-medium">Phone</p>
                  <p id="acc-phone" class="text-mint-500 text-sm">—</p>
                </div>
              </div>
              <div class="shrink-0 text-ink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/></svg></div>
            </div>

            <div class="flex items-center gap-4 bg-bg px-4 min-h-[72px] py-2 justify-between rounded-xl border border-line card-reveal">
              <div class="flex items-center gap-4">
                <div class="rounded-lg bg-mint-50 w-12 h-12 grid place-items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"><path d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80Z"/></svg>
                </div>
                <div>
                  <p class="font-medium">Privacy</p>
                  <p class="text-mint-500 text-sm">Last seen recently</p>
                </div>
              </div>
              <div class="shrink-0 text-ink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/></svg></div>
            </div>
          </section>

          <!-- Notifications -->
          <section class="mt-2 space-y-2">
            <h3 class="px-4 pt-4 pb-2 text-lg font-bold">Notifications</h3>
            <div class="flex items-center gap-4 bg-bg px-4 min-h-[72px] py-2 justify-between rounded-xl border border-line card-reveal">
              <div class="flex items-center gap-4">
                <div class="rounded-lg bg-mint-50 w-12 h-12 grid place-items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"><path d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06Z"/></svg>
                </div>
                <div>
                  <p class="font-medium">Notifications</p>
                  <p class="text-mint-500 text-sm">Message, group & call notifications</p>
                </div>
              </div>
              <div class="shrink-0 text-ink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/></svg></div>
            </div>
          </section>

          <!-- Help -->
          <section class="mt-2 space-y-2">
            <h3 class="px-4 pt-4 pb-2 text-lg font-bold">Help</h3>

            <div class="flex items-center gap-4 bg-bg px-4 min-h-14 justify-between rounded-xl border border-line card-reveal">
              <div class="flex items-center gap-4">
                <div class="rounded-lg bg-mint-50 w-10 h-10 grid place-items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"><path d="M140,180a12,12,0,1,1-12-12A12,12,0,0,1,140,180Z"/></svg>
                </div>
                <p class="text-base">Help center</p>
              </div>
              <div class="shrink-0 text-ink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/></svg></div>
            </div>

            <div class="flex items-center gap-4 bg-bg px-4 min-h-14 justify-between rounded-xl border border-line card-reveal">
              <div class="flex items-center gap-4">
                <div class="rounded-lg bg-mint-50 w-10 h-10 grid place-items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"><path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L134.87,160c-15.42-7.49-31.34-23.29-38.83-38.51l20.78-24.71c.2-.25.39-.5.57-.77a16,16,0,0,0,1.32-15.06l0-.12L97.54,33.64a16,16,0,0,0-16.62-9.52A56.26,56.26,0,0,0,32,80c0,79.4,64.6,144,144,144a56.26,56.26,0,0,0,55.88-48.92A16,16,0,0,0,222.37,158.46Z"/></svg>
                </div>
                <p class="text-base">Contact us</p>
              </div>
              <div class="shrink-0 text-ink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/></svg></div>
            </div>

            <div class="flex items-center gap-4 bg-bg px-4 min-h-14 justify-between rounded-xl border border-line card-reveal">
              <div class="flex items-center gap-4">
                <div class="rounded-lg bg-mint-50 w-10 h-10 grid place-items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"><path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34Z"/></svg>
                </div>
                <p class="text-base">Terms and privacy policy</p>
              </div>
              <div class="shrink-0 text-ink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/></svg></div>
            </div>
          </section>

          <!-- Placeholders -->
          <section id="view-communities" class="hidden">
            <div class="bg-white border border-line rounded-xl shadow-card p-6">Communities coming soon.</div>
          </section>
          <section id="view-updates" class="hidden">
            <div class="bg-white border border-line rounded-xl shadow-card p-6">Updates coming soon.</div>
          </section>
          <section id="view-calls" class="hidden">
            <div class="bg-white border border-line rounded-xl shadow-card p-6">Calls coming soon.</div>
          </section>
        </section>
      </main>
    </div>

    <!-- Firebase + Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
      import {
        getFirestore, doc, getDoc, collection, addDoc, serverTimestamp,
        query, orderBy, onSnapshot
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBIHeGBPieB4Q8hzYv-tmtRvxwHlY-8HiE",
        authDomain: "samvaad-7970b.firebaseapp.com",
        projectId: "samvaad-7970b",
        storageBucket: "samvaad-7970b.firebasestorage.app",
        messagingSenderId: "246840076262",
        appId: "1:246840076262:web:9458559ec7afa340541827"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Auth bind
      const nameEl = document.getElementById('user-name');
      const phoneEl = document.getElementById('acc-phone');
      const accName = document.getElementById('acc-name');
      const uidPill = document.getElementById('uid-pill');

      onAuthStateChanged(auth, (user)=>{
        if(!user) return location.href = './';
        const n = user.displayName || user.phoneNumber || user.email || 'User';
        if (nameEl) nameEl.textContent = n;
        if (accName) accName.textContent = n;
        if (phoneEl) phoneEl.textContent = user.phoneNumber || '—';
        if (uidPill) uidPill.textContent = `UID: ${user.uid.slice(0,6)}…`;
        me = user;
        setPeerFromURL();
      });

      // Robust logout
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn){
        logoutBtn.addEventListener('click', async ()=>{
          try{
            logoutBtn.disabled = true;
            logoutBtn.textContent = 'Logging out…';
            await signOut(auth);
          }catch(e){} finally{
            window.location.href = './';
          }
        });
      }

      // View switcher
      function switchView(name){
        const map = {
          chats: document.getElementById('view-chats'),
          settings: document.getElementById('view-settings'),
          communities: document.getElementById('view-communities'),
          updates: document.getElementById('view-updates'),
          calls: document.getElementById('view-calls'),
        };
        Object.values(map).forEach(el => { if (el) el.classList.add('hidden'); });
        if (map[name]) map[name].classList.remove('hidden');
        const vt = document.getElementById('view-title');
        if (vt) vt.textContent = name[0].toUpperCase()+name.slice(1);
        document.querySelectorAll('[data-nav]').forEach(b=>{
          const on = b.getAttribute('data-nav')===name;
          b.classList.toggle('bg-mint-50', on);
          b.classList.toggle('border', on);
          b.classList.toggle('border-line', on);
        });
      }
      ['chats','settings','communities','updates','calls'].forEach(n=>{
        const btn = document.querySelector(`[data-nav="${n}"]`);
        if (btn) btn.addEventListener('click', ()=> switchView(n));
      });

      // Chats glue
      let me=null, peer=null, unsub=null;
      const tl = document.getElementById('timeline');
      const input = document.getElementById('msg');
      const sendBtn = document.getElementById('send');
      const peerNameEl = document.getElementById('peer-name');
      const peerStatusEl = document.getElementById('peer-status');
      const emptyEl = document.getElementById('chat-empty');

      function bubble(text, mine=false){
        if (!tl) return;
        const wrap = document.createElement('div');
        wrap.className = 'flex items-end gap-3 p-2 ' + (mine?'justify-end':'');
        wrap.innerHTML = mine
          ? `<div class="flex flex-1 flex-col gap-1 items-end">
               <p class="text-chat-sub text-[13px] max-w-[360px] text-right">You</p>
               <p class="max-w-[360px] rounded-xl px-4 py-3 bg-chat-mint text-[#12211f] shadow-[0_10px_24px_rgba(0,0,0,.25)]">${text}</p>
             </div>
             <div class="w-10 h-10 rounded-full bg-cover bg-center shrink-0" style="background-image:url('https://i.pravatar.cc/100?img=5')"></div>`
          : `<div class="w-10 h-10 rounded-full bg-cover bg-center shrink-0" style="background-image:url('https://i.pravatar.cc/100?img=12')"></div>
             <div class="flex flex-1 flex-col gap-1 items-start">
               <p class="text-chat-sub text-[13px] max-w-[360px]">${(peerNameEl?.textContent || 'User')}</p>
               <p class="max-w-[360px] rounded-xl px-4 py-3 bg-chat-panel text-white shadow-[0_10px_24px_rgba(0,0,0,.25)]">${text}</p>
             </div>`;
        tl.appendChild(wrap);
        tl.scrollTop = tl.scrollHeight;
      }

      async function setPeerFromURL(){
        const q = new URLSearchParams(location.search);
        const pid = q.get('peer');
        if (!pid) return;
        try{
          const snap = await getDoc(doc(db,'users',pid));
          if (snap.exists()){
            peer = snap.data();
            if (peerNameEl) peerNameEl.textContent = peer.displayName || peer.phone || peer.email || 'User';
            if (peerStatusEl) peerStatusEl.textContent = 'Secure chat';
            if (emptyEl) emptyEl.remove();
            switchView('chats');
            listenPair();
          }
        }catch(e){}
      }

      function listenPair(){
        if (!me || !peer) return;
        if (unsub) unsub();
        const qAll = query(collection(db,'messages'), orderBy('ts','asc'));
        unsub = onSnapshot(qAll, s=>{
          if (!tl) return;
          tl.innerHTML = '';
          s.forEach(d=>{
            const m = d.data();
            if ((m.from===me.uid && m.to===peer.uid) || (m.from===peer.uid && m.to===me.uid)){
              bubble(m.text, m.from===me.uid);
            }
          });
          tl.scrollTop = tl.scrollHeight;
        });
      }

      sendBtn?.addEventListener('click', async ()=>{
        if (!peer) { alert('Select a user first (?peer=UID)'); return; }
        const text = (input?.value || '').trim();
        if (!text) return;
        await addDoc(collection(db,'messages'), { from: me.uid, to: peer.uid, text, ts: serverTimestamp() });
        if (input) input.value = '';
      });
    </script>
  </body>
</html>